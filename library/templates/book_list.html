{% if not request.user.is_authenticated %}
  <a href="{% url 'login' %}">login</a>
  <a href="{% url 'sign-in' %}">sign in</a>
  {% elif request.user.is_authenticated %}
    <a href="{% url 'book-favourite' %}">favourite book</a>
    <a href="{% url 'logout' %}">logout</a>
{% endif %}
<form method="get">
    <input type="text" name="search" placeholder="Search books..." value="{{ request.GET.search }}">
    <button type="submit">Search</button>
</form>
<form method="get">
    <div>
      {{ filterset.form.category }}
    </div>
    <input type="date" name="start" value="{{ request.GET.start }}">
    <input type="date" name="end" value="{{ request.GET.end }}">
    <input type="number" name="min_price" placeholder="Min price" value="{{ request.GET.min_price }}">
    <input type="number" name="max_price" placeholder="Max price" value="{{ request.GET.max_price }}">
    <button type="submit">Filter</button>
</form>
<form method="post">
    {% csrf_token %}
    <button type="submit" onclick="return confirm('Are you sure you want to delete selected books?')">Delete all</button>
</form>
<h1>Book</h1>
{% if request.user.is_authenticated %}
  <a href="{% url 'book-add' %}">add book</a>
  <a href="{% url 'category-add' %}">add category</a>
{% endif %}
{% for book in books %}
  <a href="{% url 'book-detail' book.pk %}">
    <h2>{{ book.title }}</h2>
  </a>
  <button 
      class="fav-btn" 
      data-book-id="{{ book.id }}">
      {% if user in book.favourites.all %}
          Remove from favourites
      {% else %}
          Add to favourites
      {% endif %}
  </button>
  {% if book.picture %}
  <img src="{{ book.picture.url }}" alt="{{ book.picture.url }}">
  {% endif %}
  <p><strong>Authors:</strong>
      {% for author in book.authors.all %}
        {{ author.first_name }} {{ author.last_name }}{% if not forloop.last %}, {% endif %}
      {% empty %}
        <em>No authors available</em>
      {% endfor %}
  </p>
  <p><strong>Categories:</strong>
      {% for category in book.category.all %}
        {{ category.name }}{% if not forloop.last %}, {% endif %}
      {% empty %}
        <em>No category available</em>
      {% endfor %}
  </p>
  <p>Published: {{ book.published_date }}</p>
  <p>Summary: {{ book.summary }}</p>
  <p><strong>Price:</strong> {{ book.price }}</p>
{% endfor %}

<script>
document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll(".fav-btn").forEach(button => {
        button.addEventListener("click", function() {
            const bookId = this.dataset.bookId;
            const csrfToken = "{{ csrf_token }}";
            const url = `favourite/toggle/${bookId}/`;

            fetch(url, {
                method: "POST",
                headers: {
                    "X-CSRFToken": csrfToken,
                    "Content-Type": "application/json",
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.is_favourite) {
                        this.textContent = "Remove from favourites";
                    } else {
                        this.textContent = "Add to favourites";
                    }
                } else {
                    alert(data.message || "Something went wrong");
                }
            })
            .catch(error => console.error("Error:", error));
        });
    });
});
</script>