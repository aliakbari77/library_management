{% extends "base.html" %}
{% block title %}{{ book.title }}{% endblock %}
{% block content %}

<div class="container mt-4">
    {% if book %}
        <div class="row">
            <!-- Book Image -->
            <div class="col-md-4">
                {% if book.picture %}
                <img src="{{ book.picture.url }}" class="img-fluid rounded shadow-sm">
                {% else %}
                <img src="https://via.placeholder.com/300x400.png?text=No+Image" class="img-fluid rounded shadow-sm">
                {% endif %}
            </div>

            <!-- Book Info -->
            <div class="col-md-8">
                <h2 class="fw-bold">{{ book.title }}</h2>
                <p class="mb-1">
                    <strong>Price:</strong> ${{ book.price|default:"N/A" }}
                </p>
                <p class="mb-1">
                    <strong>Published Date:</strong> {{ book.published_date|date:"M d, Y" }}
                </p>
                <p class="mb-2">
                    <strong>Publisher:</strong> {{ book.publisher.name }}
                </p>

                <p class="mb-2">
                    <strong>Authors:</strong>
                    {% for author in book.authors.all %}
                        {{ author.first_name }} {{ author.last_name }}{% if not forloop.last %}, {% endif %}
                    {% empty %}
                        <span class="text-muted">No Authors</span>
                    {% endfor %}
                </p>

                <p class="mb-3">
                    <strong>Categories:</strong>
                    {% for category in book.category.all %}
                        <span class="badge bg-info text-dark border">{{ category.name }}</span>
                    {% empty %}
                        <span class="text-muted">No Category</span>
                    {% endfor %}
                </p>

                <p class="mb-3">
                    <strong>Summary:</strong><br>
                    {{ book.summary|default:"No summary available." }}
                </p>

            <!-- Favourite Button -->
                {% if user.is_authenticated %}
                    <button 
                        type="button"
                        class="btn toggle-favourite"
                        data-book-id="{{ book.id }}"
                        style="background: none; border: none; cursor: pointer;"
                    >
                        <i class="fa-heart {% if user in book.favourites.all %}fa-solid text-danger{% else %}fa-regular text-muted{% endif %}" 
                            id="fav-icon-{{ book.id }}"></i>
                    </button>
                {% else %}
                    <a href="{% url 'login' %}" class="btn btn-outline-secondary">
                        <i class="fa-regular fa-heart"></i> Login to Favourite
                    </a>
                {% endif %}
                <!-- Delete -->
                {% if user.is_authenticated %}
                    <button class="btn btn-sm btn-outline-danger delete-book-btn" data-id="{{ book.id }}" title="Delete Book">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                {% endif %}
            </div>
        </div>
    {% else %}
        <p class="text-center text-muted">This book not found.</p>
    {% endif %}
</div>

<!-- AJAX Script for Add/Remove Favourite -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;

    document.querySelectorAll(".toggle-favourite").forEach(button => {
        button.addEventListener("click", function () {
            const bookId = this.dataset.bookId;
            const icon = document.querySelector(`#fav-icon-${bookId}`);

            fetch(`/library/book/favourite/toggle/${bookId}/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": csrftoken,
                    "X-Requested-With": "XMLHttpRequest"
                }
            })
            .then(response => {
                if (response.status === 401) {
                    window.location.href = "{% url 'login' %}";
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    if (data.is_favourite) {
                        icon.classList.remove("fa-regular", "text-muted");
                        icon.classList.add("fa-solid", "text-danger");
                    } else {
                        icon.classList.remove("fa-solid", "text-danger");
                        icon.classList.add("fa-regular", "text-muted");
                    }
                }
            });
        });
    });
});
</script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.querySelectorAll(".delete-book-btn").forEach(button => {
    button.addEventListener("click", function () {
        const bookId = this.dataset.id;

        Swal.fire({
            title: "Are you sure?",
            text: "This book will be permanently deleted!",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#d33",
            cancelButtonColor: "#6c757d",
            confirmButtonText: "Yes, delete it!"
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/library/book/delete/${bookId}/`, {
                    method: "DELETE",
                    headers: {
                        "X-CSRFToken": "{{ csrf_token }}",
                        "Accept": "application/json",
                    },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === "success") {
                        Swal.fire({
                            title: "Deleted!",
                            text: data.message,
                            icon: "success",
                            confirmButtonColor: "#3085d6"
                        }).then(() => {
                            window.location.href = "{% url 'book-list' %}";
                        });
                    } else {
                        Swal.fire("Error!", data.message, "error");
                    }
                })
                .catch(err => {
                    Swal.fire("Error!", "Something went wrong.", "error");
                });
            }
        });
    });
});
</script>

{% endblock %}
