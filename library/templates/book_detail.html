{% extends "base.html" %}
{% block title %}{{ book.title }}{% endblock %}
{% block content %}

<div class="container mt-4">
    <div class="row">
        <!-- Book Image -->
        <div class="col-md-4">
            {% if book.picture %}
            <img src="{{ book.picture.url }}" class="img-fluid rounded shadow-sm">
            {% else %}
            <img src="https://via.placeholder.com/300x400.png?text=No+Image" class="img-fluid rounded shadow-sm">
            {% endif %}
        </div>

        <!-- Book Info -->
        <div class="col-md-8">
            <h2 class="fw-bold">{{ book.title }}</h2>
            <p class="text-muted mb-1">
                <strong>Price:</strong> ${{ book.price|default:"N/A" }}
            </p>
            <p class="text-muted mb-1">
                <strong>Published Date:</strong> {{ book.published_date|date:"M d, Y" }}
            </p>
            <p class="text-muted mb-2">
                <strong>Publisher:</strong> {{ book.publisher.name }}
            </p>

            <p class="mb-2">
                <strong>Authors:</strong>
                {% for author in book.authors.all %}
                    {{ author.first_name }} {{ author.last_name }}{% if not forloop.last %}, {% endif %}
                {% empty %}
                    <span class="text-muted">No Authors</span>
                {% endfor %}
            </p>

            <p class="mb-3">
                <strong>Categories:</strong>
                {% for category in book.category.all %}
                    <span class="badge bg-info text-dark border">{{ category.name }}</span>
                {% empty %}
                    <span class="text-muted">No Category</span>
                {% endfor %}
            </p>

            <p class="mb-3">
                <strong>Summary:</strong><br>
                {{ book.summary|default:"No summary available." }}
            </p>

            <!-- Favourite Button -->
            {% if user.is_authenticated %}
            <button class="btn {% if user in book.favourites.all %}btn-danger{% else %}btn-outline-warning{% endif %} favourite-btn" data-book-id="{{ book.pk }}">
                {% if user in book.favourites.all %}★ Remove{% else %}☆ Favourite{% endif %}
            </button>
            {% else %}
            <p class="text-muted">Login to add to favourites.</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- AJAX Script for Add/Remove Favourite -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    const favButton = document.querySelector('.favourite-btn');

    if (favButton) {
        favButton.addEventListener('click', () => {
            const bookId = favButton.dataset.bookId;

            fetch(`/library/book/favourite/toggle/${bookId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'added') {
                        favButton.classList.remove('btn-outline-warning');
                        favButton.classList.add('btn-danger');
                        favButton.textContent = '★ Remove';
                    } else if (data.status === 'removed') {
                        favButton.classList.remove('btn-danger');
                        favButton.classList.add('btn-outline-warning');
                        favButton.textContent = '☆ Favourite';
                    }
                })
                .catch(err => console.error(err));
        });
    }
});
</script>

{% endblock %}
