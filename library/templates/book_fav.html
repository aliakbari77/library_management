{% extends "base.html" %}
{% block title %}My Favourite Books{% endblock %}
{% block content %}

<div class="container mt-4">
    <h2 class="mb-4">⭐ My Favourite Books</h2>

    {% if books %}
    <div class="row g-4">
            {% for book in books %}
            <div class="col-xl-3 col-lg-4 col-md-6 col-sm-6 book-card">
                <div class="card shadow-sm border-0 h-100">
                    {% if book.picture %}
                        <img src="{{ book.picture.url }}" class="card-img-top" style="height: 180px; object-fit: cover;">
                    {% else %}
                        <img src="https://via.placeholder.com/200x180.png?text=No+Image" class="card-img-top">
                    {% endif %}

                    <div class="card-body d-flex flex-column">
                        <!-- Book Title -->
                        <h6 class="card-title fw-bold text-truncate" title="{{ book.title }}">
                            {{ book.title }}
                        </h6>

                        <!-- Price & Date -->
                        <p class="text-muted small mb-1">
                            <i class="fa-solid fa-tag"></i> ${{ book.price }}
                        </p>
                        <p class="text-muted small">
                            <i class="fa-regular fa-calendar"></i> {{ book.published_date }}
                        </p>

                        <!-- Categories -->
                        <p class="card-text text-muted small mb-2">
                            {% for category in book.category.all %}
                                <span class="badge bg-light text-dark border">{{ category.name }}</span>
                            {% empty %}
                                <span class="text-muted">No Category</span>
                            {% endfor %}
                        </p>

                        <!-- Actions -->
                        <div class="mt-auto d-flex justify-content-between align-items-center">
                            <!-- Details -->
                            <a href="{% url 'book-detail' book.pk %}" class="btn btn-sm btn-outline-primary" title="View Details">
                                <i class="fa-solid fa-circle-info"></i>
                            </a>

                            <!-- Favourite Heart Icon -->
                            {% if user.is_authenticated %}
                                <button 
                                    type="button"
                                    class="btn btn-sm toggle-favourite"
                                    data-book-id="{{ book.id }}"
                                    title="{% if user in book.favourites.all %}Remove from favourites{% else %}Add to favourites{% endif %}"
                                    style="border: none; background: none; padding: 0; cursor: pointer;"
                                >
                                    <i class="fa-heart {% if user in book.favourites.all %}fa-solid text-danger{% else %}fa-regular text-muted{% endif %}" id="fav-icon-{{ book.id }}"></i>
                                </button>
                            {% else %}
                                <a href="{% url 'login' %}" class="btn btn-sm btn-outline-secondary" title="Login to add favourite">
                                    <i class="fa-regular fa-heart"></i>
                                </a>
                            {% endif %}


                            <!-- Delete -->
                            {% if user.is_authenticated %}
                                <button class="btn btn-sm btn-outline-danger delete-book-btn" data-id="{{ book.id }}" title="Delete Book">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <p class="text-muted text-center">No books found matching your filters.</p>
            {% endfor %}
        </div>
    {% else %}
        <p class="text-center text-muted">You haven’t added any favourite books yet.</p>
    {% endif %}
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    document.querySelectorAll(".toggle-favourite").forEach(button => {
        button.addEventListener("click", function () {
            const bookId = this.getAttribute("data-book-id");
            const icon = document.querySelector(`#fav-icon-${bookId}`);

            fetch(`/library/book/favourite/toggle/${bookId}/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": csrftoken,
                    "X-Requested-With": "XMLHttpRequest"
                }
            })
            .then(response => {
                if (response.status === 401) {
                    window.location.href = "{% url 'login' %}";
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    if (data.is_favourite) {
                        icon.classList.remove("fa-regular", "text-muted");
                        icon.classList.add("fa-solid", "text-danger");
                    } else {
                        icon.classList.remove("fa-solid", "text-danger");
                        icon.classList.add("fa-regular", "text-muted");
                        const card = this.closest('.col-xl-3, .col-lg-4, .col-md-6');
                        card.remove();
                    }
                }
            })
            .catch(error => console.error("Error:", error));
        });
    });
});
</script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.querySelectorAll(".delete-book-btn").forEach(button => {
    button.addEventListener("click", function () {
        const bookId = this.dataset.id;

        Swal.fire({
            title: "Are you sure?",
            text: "This book will be permanently deleted!",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#d33",
            cancelButtonColor: "#6c757d",
            confirmButtonText: "Yes, delete it!"
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/library/book/delete/${bookId}/`, {
                    method: "DELETE",
                    headers: {
                        "X-CSRFToken": "{{ csrf_token }}",
                        "Accept": "application/json",
                    },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === "success") {
                        Swal.fire({
                            title: "Deleted!",
                            text: data.message,
                            icon: "success",
                            confirmButtonColor: "#3085d6"
                        });
                        // Remove the deleted book card from the DOM
                        this.closest(".col-xl-3, .col-lg-4, .col-md-6, .col-sm-6").remove();
                    } else {
                        Swal.fire("Error!", data.message, "error");
                    }
                })
                .catch(err => {
                    Swal.fire("Error!", "Something went wrong.", "error");
                });
            }
        });
    });
});
</script>
{% endblock %}
